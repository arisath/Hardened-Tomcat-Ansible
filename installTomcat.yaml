---

 - name: Download Tomcat from Apache
   get_url: url="https://archive.apache.org/dist/tomcat/tomcat-9/v{{tomcat_version}}/src/apache-tomcat-{{tomcat_version}}-src.zip" dest=/tmp/ force=no

 - name: Unzip Tomcat
   command: unzip -o /tmp/tomcat-{{tomcat_version}}.zip -d /var/
   become: yes
   become_user: root

 # - name: Change tomcat folder user permissions
 #   file:
 #    path: /var/apache-tomcat-{{tomcat_version}}
 #    owner: {{tomcat_user}}
 #    group: {{tomcat_group}}
 #    recurse: yes
 #    state: directory
 #   become: yes
 #   become_user: root

 - name: Make Tomcat executable
   command: "/bin/sh -c 'chmod 755 /var/apache-tomcat-{{tomcat_version}}/bin/*.sh'"
   become: yes
   become_user: root

 - name: Make tomcat service script executable
   command: chmod 755 /tmp/tomcat
   become: yes
   become_user: root

 - name: Move Tomcat startup script to init.d
   command: cp /tmp/tomcat  /etc/init.d/
   become: yes
   become_user: root

 - name: Register Tomcat
   command: chkconfig --add tomcat
   become: yes
   become_user: root

 - name: Replace the server.xml to enable ssl
   command: cp /tmp/server.xml /var/apache-tomcat-{{ tomcat_version }}/conf/server.xml
   become: yes
   become_user: tomcat

 - name: Delete Tomcat Examples folder
   file:
     path: /var/apache-tomcat-{{tomcat_version}}/webapps/examples
     state: absent
   become: yes
   become_user: root

 - name: Start Tomcat
   command: service tomcat start
   become: yes
   become_user: root

 - name: Wait for Tomcat to start
   shell: curl --head http://localhost:8080
   register: result
   until: result.stdout.find("200 OK") != -1
   retries: 10
   delay: 30

 - name: Delete the templates folder locally
   local_action: command rm -rf {{jenkins_workspace}}/ansible/roles/installTomcat/templates
